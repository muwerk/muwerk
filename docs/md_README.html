<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>muwerk Scheduler Library: muwerk</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">muwerk Scheduler Library
   </div>
   <div id="projectbrief">A low-resource cooperative scheduler with MQTT-like queues for Arduinos, ATtiny up to ESP32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">muwerk </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a href="https://travis-ci.org/muwerk/muwerk"><img src="https://travis-ci.org/muwerk/muwerk.svg?branch=master" alt="ESP12e build" style="pointer-events: none;" class="inline"/></a> <a href="https://muwerk.github.io/muwerk/docs/index.html"><img src="https://img.shields.io/badge/docs-dev-blue.svg" alt="Dev Docs" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/muwerk/muwerk/actions"><img src="https://github.com/muwerk/muwerk/workflows/CMake/badge.svg" alt="CMake" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/muwerk/muwerk/actions"><img src="https://github.com/muwerk/muwerk/workflows/PlatformIO%20CI/badge.svg" alt="PlatformIO CI" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/muwerk/muwerk/actions"><img src="https://github.com/muwerk/muwerk/workflows/Console/badge.svg" alt="Console" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/muwerk/muwerk/actions"><img src="https://github.com/muwerk/muwerk/workflows/Raspberry_Pico/badge.svg" alt="Raspberry_Pico" style="pointer-events: none;" class="inline"/></a></p>
<p >muwerk is a cooperative scheduler with mqtt-like queues.</p>
<h1>Dependencies </h1>
<p >muwerk relies only on <a href="https://github.com/muwerk/ustd">ustd</a>. Check documentation for required <a href="https://github.com/muwerk/ustd/blob/master/README.md">platform defines</a>.</p>
<h1>Project overview </h1>
<p >muwerk provides a cooperative scheduler that allows fixed-intervall task creation on platforms from attiny up to ESP32 and Linux. (Linux support for testing with debuggers and valgrind.)</p>
<p >Tasks can simply be created by: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">#define __ESP__ 1  // replace with appropriate platform define</div>
<div class="line">#include &quot;scheduler.h&quot;</div>
<div class="line"> </div>
<div class="line">ustd::Scheduler sched;</div>
<div class="line"> </div>
<div class="line">void myTask() {</div>
<div class="line">    // add code for this task here</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">    int tID = sched.add(myTask, &quot;taskname&quot;, 50000L);</div>
<div class="line">}</div>
</div><!-- fragment --><p >This example creates a task identified by function <code>void myTask()</code> with task-name <code>taskname</code> that is executed every 50ms (50000us). On ESP8266 minimum schedule time is around 50us.</p>
<p >The arduino main look simply needs to contain the line: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">void loop() {</div>
<div class="line">    sched.loop();</div>
<div class="line">}</div>
</div><!-- fragment --><p> This calls the muwerk scheduler who dispatches the registered tasks.</p>
<h1>Statistics </h1>
<p >If a message with topic <code>$SYS/stat/get</code> with string-encoded integer <code>N</code> as message is received, the scheduler sends a statistics json object to topic <code>$SYS/stat</code> every <code>N</code> milliseconds. If <code>N</code> is zero, no more stat information is published.</p>
<p >Sample stat json (single output-line from <code>Examples/mac-linux</code>):</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;dt&quot; : 500001, &quot;syt&quot; : 57340, &quot;apt&quot; : 347452, &quot;mat&quot; : 10, &quot;upt&quot;:2, &quot;mem&quot;:2147483647, &quot;tsks&quot; : 2,</div>
<div class="line">        &quot;tdt&quot; : [[&quot;task1&quot;, 1, 50000, 10, 99240, 7], [&quot;task2&quot;, 2, 75000, 7, 34937, 0]]}</div>
</div><!-- fragment --><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Explanation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">dt   </td><td class="markdownTableBodyNone">Âµsec since last stat sample    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">syt   </td><td class="markdownTableBodyNone">time in usec used by OS    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">apt   </td><td class="markdownTableBodyNone">time in usec used by mwerk tasks    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">mat   </td><td class="markdownTableBodyNone">time in usec for housekeeping    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">upt   </td><td class="markdownTableBodyNone">uptime of system in seconds    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">mem   </td><td class="markdownTableBodyNone">free memory, max. INT_MAX for unixoids    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">tsks   </td><td class="markdownTableBodyNone">number of muwerk tasks <code>tn</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">tdt   </td><td class="markdownTableBodyNone">array of <code>tn</code> entries for each task, containing: task-name <code>tname</code> , <code>tid</code> taskID of process, <code>sched_time</code> scheduling time, number of times task was executed during sample time <code>cn</code>, usecs used by this task during this sample <code>sct</code>, accumulated usecs task execution was later than scheduled <code>slt</code>   </td></tr>
</table>
<p >This example shows a <code>dt=500ms</code> sample, it has two tasks, <code>task1</code>, <code>id=1</code> was called 10 times, every 50ms, and used average 9.9240ms per call (task-code has approx. 10ms sleep), and <code>task2</code>, <code>id=2</code> was called 7 times, every 75ms, and used average 4.991ms (5ms sleep in code). Both tasks were always executed as schedules (negligable late-times <code>cn</code>).</p>
<p >See <code>Examples\mac-linux</code>. (Not available on ATTINY platforms, only ATMEGA and better).</p>
<p >For systems that are connected to an MQTT-server (via <a href="https://github.com/muwerk/munet/blob/master/README.md"><code>munet</code></a>), a python example script <a href="https://github.com/muwerk/muwerk/tree/master/Examples/mutop">mutop</a> shows how to parse the statistical information.</p>
<h1>MQTT-like Communications and Architecture Overview </h1>
<p >A more complete example is available at <a href="https://github.com/muwerk/muwerk/blob/master/Examples/minimal/src/mu_minimal.cpp">blink</a> that shows how tasks can communicate MQTT-style with each other and &ndash; blink a led.</p>
<p >Tasks can communicate with each other using an MQTT-like pub/sub mechanism. On ESP8266 or ESP32 platforms, the internal communication can be exported transparently using <a href="https://github.com/muwerk/munet">munet</a>'s interface to the <a href="https://github.com/knolleary/pubsubclient">PubSubClient</a> Arduino MQTT library. The scheduler's task information is also exported via MQTT.</p>
<p >See the <a href="https://muwerk.github.io/muwerk/docs/classustd_1_1Scheduler.html">documentation</a> for more samples on muwerk's task scheduler and pub/sub intertask communication.</p>
<div class="fragment"><div class="line">               +-------------------------------+</div>
<div class="line">               |            Apps               |  Samples</div>
<div class="line">               +-------------------------------+</div>
<div class="line">                              |</div>
<div class="line">               +-------------------------------+</div>
<div class="line">               |          Mupplets             |  Sensors, IO-libs, reusable functional units</div>
<div class="line">               +-------------------------------+</div>
<div class="line">                     |                |</div>
<div class="line">+------------+       |        +----------------+  Munet: ESP8266 and ESP32 only:</div>
<div class="line">|  Testcode  |       |        |  munet (ESPx)  |  Access point client connection, NTP,</div>
<div class="line">+------------+       |        +----------------+    OTA-update, MQTT (via PubSubClient)</div>
<div class="line">       |             |                |</div>
<div class="line">+----------------------------------------------+</div>
<div class="line">|                   muwerk                     |  Cooperative scheduler and task-to-task</div>
<div class="line">+----------------------------------------------+    MQTT-like communication (pub/sub)</div>
<div class="line">       |             |                |</div>
<div class="line">+----------------------------------------------+</div>
<div class="line">|                    ustd                      |  Minimal implementations of Queue, Map (Dicts),</div>
<div class="line">+----------------------------------------------+    Arrays</div>
<div class="line">       |             |                |</div>
<div class="line">+------------+ +------------+ +----------------+</div>
<div class="line">| Mac, Linux | |Arduino SDK | | ESP8266/32 SDK |  OS and Arduino-Frameworks</div>
<div class="line">+------------+ +------------+ +----------------+</div>
</div><!-- fragment --><h1>Debugging and Troubleshooting </h1>
<p ><img src="https://github.com/muwerk/muwerk/blob/master/Resources/console.jpg?raw=true" alt="" align="right" width="480" class="inline"/></p>
<p >The <a href="https://muwerk.github.io/muwerk/docs/classustd_1_1Console.html"><code>Console</code></a> class allows to bind a serial console to muwerk that allows to inspect message passing, file system (if available) and statistical information. See the <a href="https://github.com/muwerk/muwerk/blob/master/Examples/console/mu_console.cpp"><code>mu_console</code></a> example for more information.</p>
<h1>Documentation </h1>
<ul>
<li><a href="https://muwerk.github.io/muwerk/docs/index.html">ustd::muwerk documentation.</a></li>
<li><code>ustd</code> required <a href="https://github.com/muwerk/ustd/blob/master/README.md">platform defines.</a></li>
<li><a href="https://muwerk.github.io/ustd/docs/index.html">ustd:: documentation.</a></li>
</ul>
<h1>Related projects: </h1>
<ul>
<li><a href="https://github.com/muwerk/ustd/blob/master/README.md">ustd</a> (micro-stdlib), a minimal implementation of array, vector and map c++ classes that work on all arduino platforms, from 8kb attiny up to ESP32 and Unixoids Mac or Linux (for testing).</li>
<li><a href="https://github.com/muwerk/muwerk/blob/master/README.md">muwerk</a> (microWerk), a cooperative scheduler and an MQTT-like communication-queue for all arduino devices (attiny up to ESP32 [and Unixoids Mac or Linux for testing])</li>
<li><a href="https://github.com/muwerk/munet/blob/master/README.md">munet</a>, modules for network connectivity for ESP8266 and ESP32 devices, implements Wireless connection to access point, NTP time protocol, OTA over-the-air udpate, MQTT-stack (using [PubSubClient]).</li>
<li><a href="https://github.com/muwerk/mupplet-core">mupplets</a>, <a href="https://github.com/muwerk/mupplet-sensor">mupplet-sensor</a> a number of implementations for sensors and io-devices. Mupplets implement processes for muwerk and expose muwerk's pub/sub interface to allow other mupplets or apps to access the mupplet's functionality. Mupplets can be sensor-drivers or or more specialized modules, e.g. clock functionality for a led display.</li>
<li><a href="https://github.com/muwerk/examples">examples</a> show the excellent composability using tasks and messages.</li>
</ul>
<h1>History </h1>
<ul>
<li>0.6.3 (2022-08-26) Support update() function for sensor filter params</li>
<li>0.6.2 (2021-02-xx) (not yet released) Scheduler support for rp2040 Raspberry Pico, fix <a class="el" href="console_8h_source.html">console.h</a> data type.</li>
<li>0.6.1 (2021-02-12)<ul>
<li>New: numericFunction approximator class: piece-wise linear approximation of a function defined by a set of points (x1,y1), (x2, y2)...(xn,yn) for calibration etc.</li>
<li>fix: <code><a class="el" href="doctor_8h_source.html">doctor.h</a></code> and <code><a class="el" href="i2cdoctor_8h_source.html">i2cdoctor.h</a></code> hat wrong casing for <code>Arduino_JSON.h</code> include.</li>
</ul>
</li>
<li>0.6.0 (2021-01-30) <b>Breaking change</b> for ustd library include: ustd include-files have now <code>ustd_</code> prefix to prevent name-clashes with various platform-sdks. [queue.h clashed with ESP8266-Wifi, platform.h clashed with RISC-V SDK, hence new names <code>ustd_queue.h</code> and <code>ustd_platform.h</code> etc.]</li>
<li>0.5.5 (2021-01-29) Support for all platforms with <code>Doctor</code> and <code>I2CDoctor</code>.</li>
<li>CI (2021-01-28 All supported platforms are build-checked automatically with Github actions.</li>
<li>0.5.4 (2021-01-28) Minor fixes:<ul>
<li><code><a class="el" href="classustd_1_1Console.html" title="muwerk Console Class">ustd::Console</a></code> and <code><a class="el" href="classustd_1_1SerialConsole.html" title="muwerk Serial Console Class">ustd::SerialConsole</a></code> do now honour the USTD_FEATURE_xxx defines.</li>
<li>Safe struct inits (no memset())</li>
<li>Support for new platforms defined in <a href="https://github.com/muwerk/ustd#platform-defines">ustd</a> (new platforms for <code>__ARM__</code>, <code>__RISC_V__</code>)</li>
</ul>
</li>
<li>0.5.3 (2021-01-22) <code>UST_FEATURE_MEM</code> defines used (requires <code>ustd</code> version 0.4.1 or higher), ATtiny T_TASK limited to static functions.</li>
<li>0.5.2 (2021-01-20) <code>library.properties</code> project name repaired, to allow Arduino automatic update.</li>
<li>0.5.1 (2021-01-19)<ul>
<li>Added <code>readString</code> with length validation to <code><a class="el" href="classustd_1_1jsonfile.html" title="muwerk JSON File Class">ustd::jsonfile</a></code></li>
<li>New task <code>ustd::doctor</code> implements a remote diagnostics interface via pub/sub messages.</li>
<li><code><a class="el" href="classustd_1_1Console.html" title="muwerk Console Class">ustd::Console</a></code> has now a better interface for using other Printer-derived stream objects, <code><a class="el" href="classustd_1_1SerialConsole.html" title="muwerk Serial Console Class">ustd::SerialConsole</a></code> can now be used with alternative serial interfaces</li>
<li>Improvements to stability and memory handling on <code><a class="el" href="classustd_1_1Scheduler.html" title="muwerk Scheduler Class">ustd::Scheduler</a></code></li>
<li>Additional commandline options for <code>mutop</code></li>
</ul>
</li>
<li>0.5.0 (2021-01-15) Major update including:<ul>
<li>New Serial Console class that provides a minimal interactive shell that can be extended with custom commands.</li>
<li>New portable filesystem functions that provide abstraction between LittleFS and SPIFFS (and in future others).</li>
<li>New class for managing JSON files with possibility to access members with an MQTT-topic-like path syntax.</li>
<li>New utility classes <code>heartbeat</code> and <code>timeout</code>.</li>
<li>New utility functions <code>shift</code> and <code>split</code> for string argument handling.</li>
<li>Analysis tool <code>mutop</code> that allows to monitor tasks and resource consumption for mqtt connected systems.</li>
<li><code>$SYS/STAT</code> format expanded to contain uptime, free memory, and per-task infos task-id and schedule-time.</li>
</ul>
</li>
<li>0.4.0 (2021-01-11) Optional serial console for muwerk, file system support for ESP8266 and ESP32.</li>
<li>0.3.2 (2020-12-25) Small platform updates, no functional change.</li>
<li>0.3.1 (2019-11-29) Compile problem with attiny: resetStats() referenced for attiny.</li>
<li>0.3.0 (2019-11-28) Statistical information is no longer flooding serial port, but is published (on demand) to topic <code>$SYS/stat</code>. Use publish to <code>$SYS/stat/get</code>, message body <code>number</code> (as string encoded) to receive stat information every <code>number</code> milliseconds.</li>
<li>0.2.1 (2019-09-19) Functional support for AVRs via <a href="https://muwerk.github.io/ustd/docs/index.html"><code>ustd::function&lt;&gt;</code></a>.</li>
</ul>
<h1>References </h1>
<p ><code>muwerk</code> is a derivative and lightweight version of <a href="https://github.com/yeasoft/Meisterwerk">Meisterwerk</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
